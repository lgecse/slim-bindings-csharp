# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: "3"

vars:
  SLIM_BINDINGS_VERSION: '{{.SLIM_BINDINGS_VERSION | default "0.7.3"}}'
  SLIM_DIR: '{{.SLIM_DIR | default "../slim"}}'
  UNIFFI_BINDGEN_CS_VERSION: "v0.9.0+v0.28.3"

tasks:
  default:
    cmds:
      - task -l

  setup:
    desc: Download pre-built native libraries for local development
    cmds:
      - task: download
      - echo "Setup complete. Run 'task build' to build."

  download:
    desc: Download pre-built native libraries from slim release
    cmds:
      - mkdir -p artifacts
      - gh release download slim-bindings-libs-v{{.SLIM_BINDINGS_VERSION}} --repo agntcy/slim --pattern "*.zip" --dir artifacts/ --clobber
      - |
        for zip in artifacts/*.zip; do
          target="${zip#artifacts/slim-bindings-}"
          target="${target%.zip}"
          case "$target" in
            x86_64-unknown-linux-gnu)   rid="linux-x64" ;;
            x86_64-unknown-linux-musl)  rid="linux-musl-x64" ;;
            aarch64-unknown-linux-gnu)  rid="linux-arm64" ;;
            aarch64-unknown-linux-musl) rid="linux-musl-arm64" ;;
            x86_64-apple-darwin)        rid="osx-x64" ;;
            aarch64-apple-darwin)       rid="osx-arm64" ;;
            x86_64-pc-windows-msvc)     rid="win-x64" ;;
            x86_64-pc-windows-gnu)      rid="win-x64-gnu" ;;
            *) continue ;;
          esac
          mkdir -p "runtimes/$rid/native"
          unzip -oj "$zip" -d "runtimes/$rid/native/"
          for f in runtimes/$rid/native/*slim_bindings*; do
            case "$f" in
              *.so)    mv "$f" "runtimes/$rid/native/libslim_bindings.so" ;;
              *.dylib) mv "$f" "runtimes/$rid/native/libslim_bindings.dylib" ;;
              *.dll)   mv "$f" "runtimes/$rid/native/slim_bindings.dll" ;;
            esac
          done
        done
        rm -rf artifacts
      - echo "Libraries downloaded to runtimes/"

  regenerate:
    desc: Regenerate C# bindings when upstream slim changes (requires slim repo)
    cmds:
      - |
        if [ ! -d "{{.SLIM_DIR}}/data-plane/bindings/rust" ]; then
          echo "Error: slim repo not found at {{.SLIM_DIR}}" >&2
          echo "Clone it: git clone https://github.com/agntcy/slim.git {{.SLIM_DIR}}" >&2
          exit 1
        fi
      - task: download
      - cargo install uniffi-bindgen-cs --git https://github.com/NordSecurity/uniffi-bindgen-cs.git --tag {{.UNIFFI_BINDGEN_CS_VERSION}} 2>/dev/null || true
      - mkdir -p SlimBindings/generated
      - |
        if [ -f "runtimes/osx-arm64/native/libslim_bindings.dylib" ]; then
          lib="$(pwd)/runtimes/osx-arm64/native/libslim_bindings.dylib"
        elif [ -f "runtimes/osx-x64/native/libslim_bindings.dylib" ]; then
          lib="$(pwd)/runtimes/osx-x64/native/libslim_bindings.dylib"
        else
          lib="$(pwd)/runtimes/linux-x64/native/libslim_bindings.so"
        fi
        cd {{.SLIM_DIR}}/data-plane/bindings/rust
        uniffi-bindgen-cs --library "$lib" --out-dir "$OLDPWD/SlimBindings/generated"
      - echo "Bindings regenerated. Commit SlimBindings/generated/ if changed."

  build:
    desc: Build the C# project
    cmds:
      - dotnet build SlimBindings.sln

  test:
    desc: Run tests
    cmds:
      - dotnet test SlimBindings.sln {{.CLI_ARGS}}

  test:smoke:
    desc: Run smoke tests (no server required)
    cmds:
      - dotnet test SlimBindings.sln --filter "Category!=Integration" {{.CLI_ARGS}}

  pack:
    desc: Create NuGet package
    cmds:
      - dotnet pack SlimBindings/SlimBindings.csproj -c Release -o packages/

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf runtimes packages artifacts
      - dotnet clean SlimBindings.sln 2>/dev/null || true
