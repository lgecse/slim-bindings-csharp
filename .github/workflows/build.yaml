# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DOTNET_VERSION: "8.0.x"
  SLIM_BINDINGS_VERSION: "0.7.3"

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download native libraries
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download slim-bindings-libs-v${{ env.SLIM_BINDINGS_VERSION }} \
            --repo agntcy/slim --pattern "*.zip" --dir artifacts/
          
          for zip in artifacts/*.zip; do
            target="${zip#artifacts/slim-bindings-}"
            target="${target%.zip}"
            case "$target" in
              x86_64-unknown-linux-gnu)   rid="linux-x64" ;;
              x86_64-unknown-linux-musl)  rid="linux-musl-x64" ;;
              aarch64-unknown-linux-gnu)  rid="linux-arm64" ;;
              aarch64-unknown-linux-musl) rid="linux-musl-arm64" ;;
              x86_64-apple-darwin)        rid="osx-x64" ;;
              aarch64-apple-darwin)       rid="osx-arm64" ;;
              x86_64-pc-windows-msvc)     rid="win-x64" ;;
              x86_64-pc-windows-gnu)      rid="win-x64-gnu" ;;
              *) continue ;;
            esac
            mkdir -p "runtimes/$rid/native"
            unzip -j "$zip" -d "runtimes/$rid/native/"
            for f in runtimes/$rid/native/*slim_bindings*; do
              case "$f" in
                *.so)    mv "$f" "runtimes/$rid/native/libslim_bindings.so" ;;
                *.dylib) mv "$f" "runtimes/$rid/native/libslim_bindings.dylib" ;;
                *.dll)   mv "$f" "runtimes/$rid/native/slim_bindings.dll" ;;
              esac
            done
          done
          rm -rf artifacts

      - name: Build and test
        run: |
          dotnet build SlimBindings.sln -c Release
          dotnet test SlimBindings.sln -c Release --filter "Category!=Integration"

      - name: Create NuGet package
        if: github.event_name == 'push'
        run: dotnet pack SlimBindings/SlimBindings.csproj -c Release -o packages/

      - name: Upload package
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: packages/*.nupkg

  publish:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: nuget
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: packages/

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - run: |
          dotnet nuget push packages/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
