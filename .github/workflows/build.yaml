# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  DOTNET_VERSION: "8.0.x"

jobs:
  build-native:
    name: Build Native (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            rid: osx-arm64
            lib: libslim_bindings.dylib
          - os: macos-13
            target: x86_64-apple-darwin
            rid: osx-x64
            lib: libslim_bindings.dylib
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rid: linux-x64
            lib: libslim_bindings.so
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            rid: linux-arm64
            lib: libslim_bindings.so
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rid: win-x64
            lib: slim_bindings.dll

    steps:
      - name: Checkout slim-bindings-csharp
        uses: actions/checkout@v4

      - name: Checkout slim
        uses: actions/checkout@v4
        with:
          repository: agntcy/slim
          path: slim

      - name: Install Rust
        uses: dtolnay/rust-action@1.84.0
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            slim/data-plane/target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('slim/data-plane/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Build Native Library
        working-directory: slim/data-plane/bindings/rust
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare Artifact
        shell: bash
        run: |
          mkdir -p runtimes/${{ matrix.rid }}/native
          cp slim/data-plane/target/${{ matrix.target }}/release/${{ matrix.lib }} \
             runtimes/${{ matrix.rid }}/native/

      - name: Upload Native Library
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: runtimes/
          retention-days: 1

  generate-bindings:
    name: Generate C# Bindings
    runs-on: macos-14
    needs: []
    steps:
      - name: Checkout slim-bindings-csharp
        uses: actions/checkout@v4

      - name: Checkout slim
        uses: actions/checkout@v4
        with:
          repository: agntcy/slim
          path: slim

      - name: Install Rust
        uses: dtolnay/rust-action@1.84.0

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            slim/data-plane/target/
          key: ${{ runner.os }}-bindgen-cargo-${{ hashFiles('slim/data-plane/**/Cargo.lock') }}

      - name: Install uniffi-bindgen-cs
        run: |
          cargo install uniffi-bindgen-cs \
            --git https://github.com/NordSecurity/uniffi-bindgen-cs.git \
            --tag v0.9.0+v0.28.3

      - name: Build Rust Library
        working-directory: slim/data-plane/bindings/rust
        run: cargo build --release

      - name: Generate C# Bindings
        run: |
          mkdir -p SlimBindings/generated
          cd slim/data-plane/bindings/rust
          uniffi-bindgen-cs \
            --library target/release/libslim_bindings.dylib \
            --out-dir ${{ github.workspace }}/SlimBindings/generated

      - name: Upload Generated Bindings
        uses: actions/upload-artifact@v4
        with:
          name: generated-bindings
          path: SlimBindings/generated/
          retention-days: 1

  build-dotnet:
    name: Build & Test .NET
    runs-on: ubuntu-latest
    needs: [build-native, generate-bindings]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download Generated Bindings
        uses: actions/download-artifact@v4
        with:
          name: generated-bindings
          path: SlimBindings/generated/

      - name: Download All Native Libraries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: runtimes/
          merge-multiple: true

      - name: List Runtimes
        run: find runtimes -type f

      - name: Build Solution
        run: dotnet build SlimBindings.sln -c Release

      - name: Run Smoke Tests with Coverage
        run: |
          dotnet test SlimBindings.sln -c Release \
            --filter "Category!=Integration" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 5

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            SlimBindings/bin/Release/
            SlimBindings/generated/
            runtimes/
          retention-days: 5

  pack:
    name: Create NuGet Package
    runs-on: ubuntu-latest
    needs: [build-dotnet]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download Generated Bindings
        uses: actions/download-artifact@v4
        with:
          name: generated-bindings
          path: SlimBindings/generated/

      - name: Download All Native Libraries
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: runtimes/
          merge-multiple: true

      - name: List Package Contents
        run: |
          echo "=== Generated Bindings ==="
          ls -la SlimBindings/generated/
          echo "=== Native Libraries ==="
          find runtimes -type f -exec ls -lh {} \;

      - name: Create NuGet Package
        run: dotnet pack SlimBindings/SlimBindings.csproj -c Release -o packages/

      - name: Upload NuGet Package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: packages/*.nupkg
          retention-days: 30

  # Optional: Publish to NuGet on tag
  publish:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: [pack]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: nuget
    steps:
      - name: Download NuGet Package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: packages/

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish to NuGet
        run: |
          dotnet nuget push packages/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
